# 00_INVARIANTS（不変条件）

このドキュメントは **開発中に変えない契約** です。
以後の実装・リファクタ・機能追加・性能改善は、必ず本不変条件を満たす必要があります。

## I. プロセス不変条件（Process）

### I-1. 「設定が真実」
- Hydra YAML（+ CLI override）が **唯一の真実（source of truth）**。
- コード内にハードコードされた隠れ設定を作らない。
- 実行時の有効設定は必ず `manifest` に保存し、再現可能にする。

### I-2. 比較可能性（comparable runs）
- 比較の対象は **Artifact** であり、Artifactは `manifest`（入力・設定・コード識別子）を持つ。
- 目的変数（膜厚/組成/占有率…）や特徴量の計算は、実行条件と同様に `manifest` に記録する。
- 「同じ設定なら同じID（run_id / artifact_id）」を原則とし、キャッシュと再現性を担保する。

### I-3. スキュー禁止（train/eval skew禁止）
- 特徴量化・前処理は **Pipelineとして一元化** し、train/eval/predictで処理がズレないようにする。
- 手作業の後処理で得た値を学習に混ぜない（必ずArtifact化）。

### I-4. Blocked運用（タスク管理）
- 「順番待ち」は `depends_on` で表現する。
- 「blocked」は **解除用の子タスク** を作り、親に `unblocks` を設定して解除可能にする。
- タスクは「途中のまま次へ進まない」。Acceptance Criteria と Verification が通るまで完了扱いにしない。

## II. アーキテクチャ不変条件（Architecture）

### II-1. シミュレーションBackendは差し替え可能
- Canteraはあくまで `SimulationBackend` の **実装の1つ**。
- 解析ロジックは Backend固有APIに依存しない（依存はRunArtifactだけ）。

### II-2. カテゴリ単位の独立実行
以下のカテゴリは **単独実行**できるように設計する。
- sim（実行）
- observables（目的変数算出）
- graphs（反応ネットワーク表現）
- features（特徴量）
- sensitivity（摂動/仮想削除）
- assimilation（同化）
- optimization（最適化）
- reduction（縮退）
- viz（可視化）

カテゴリ間の接続は **Artifact入出力のみ**（関数呼び出し直接依存は禁止）。

### II-3. Artifactはイミュータブル（原則）
- Artifactは作成後に内容を変更しない。
- 更新が必要なら新しいArtifactとして保存し、親子関係を `parents` に記録する。
- 例外が必要なら docs に明示し、理由と影響範囲を記す（基本は避ける）。

### II-4. “便利関数”増殖の抑止
- 共有ロジックの増殖は、将来スパゲッティ化の原因になる。
- 共通化したくなったら、まず「Artifact契約」や「Task API」の設計変更で吸収できないか検討する。

## III. 運用・安全の不変条件（Ops / Safety）

### III-1. 自動実行は止めない（ただし安全）
- Codex自動開発ループは `codex exec --full-auto` を前提とする。
- ネットワーク利用やリポジトリ外操作は自動化で止まりやすい。
  - 原則としてネットワークを使わない。
  - 使う必要がある場合は、必ず TODO として運用手順に切り出す。

### III-2. 再現性のためのメタデータ保存
- 実行環境・依存バージョン・git hash（取得できる場合）を `manifest` に保存する。
- 乱数seedを必ず保存し、固定できるようにする。

### III-3. 観測（目的変数）は後から差し替え可能
- 観測は `Observable` プラグインとして追加する。
- 既存RunArtifactから再計算可能であること（再シミュ不要が理想）。

## IV. 将来拡張に関する不変条件（汎用基盤化）

本コードは化学反応解析に留まらず、将来以下を扱い得る：
- 空間多次元の目的変数（例: 2D/3D分布）
- 時系列・イベント列
- 画像・動画などの高次元入力
- 深層学習モデル（DNN/GNN）
- データセット管理・実験管理

そのために：
- Artifactは **汎用の保存形式**（zarr/parquet/npz等）を採用し、拡張フィールドを許容する。
- 可視化は「データ→図」の変換を標準化し、可視化だけが特別なデータ経路を持たないようにする。

