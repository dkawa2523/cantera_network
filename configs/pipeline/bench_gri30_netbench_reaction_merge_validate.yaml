# NetBench: reaction merge (reaction_lumping -> prune patch) + multi-case QoI validation + viz
steps:
  - id: sim
    task: sim.run_csv
    sim: ${sim}
    params:
      conditions_file: ${benchmarks.conditions_file}
      case_id: ${benchmarks.case_id}

  - id: graph_mech
    task: graphs.stoich
    graphs:
      mechanism: ${mechanism.path}
    params: {}

  - id: graph_flux
    task: graphs.temporal_flux
    inputs:
      run_id: "@sim"
      mechanism: ${mechanism.path}
    params: {}

  - id: reaction_lumping
    task: reduction.reaction_lumping
    inputs:
      graph_id: "@graph_mech"
    lumping:
      method: threshold
      threshold: 0.8
      similarity:
        metric: jaccard
        mode: union
        weights:
          reactants: 0.5
          products: 0.5
        include_participants: false
      representative:
        metric: degree

  - id: red_rxn_merge
    task: reduction.reaction_lumping_prune
    inputs:
      reaction_lumping: "@reaction_lumping"
    mechanism: ${mechanism.path}
    params: {}

  - id: val_rxn_merge
    task: reduction.validate
    inputs:
      patches: ["@red_rxn_merge"]
    mechanism: ${mechanism.path}
    validation:
      pipeline: bench_gri30_netbench_validation
      case_mode: all
      conditions_file: ${oc.select:benchmarks.validation_conditions_file,benchmarks/assets/conditions/gri30_netbench_val.csv}
      metric: rel
      tolerance: 0.5
      stop_on_fail: false
      use_multipliers_only: true
      sim_step_id: sim
      observables_step_id: observables
      features_step_id: features

  - id: viz
    task: viz.benchmark_report
    name: bench_gri30_netbench_reaction_merge_validate
    dashboard: benchmark
    chart_backend: svg
    export_images:
      enabled: true
      formats: [svg]
      dir: images
    inputs:
      runs: "@sim"
      graphs: ["@graph_mech", "@graph_flux"]
      reduction: ["@red_rxn_merge"]
      validation: ["@val_rxn_merge"]
    graphviz:
      top_n: 8
      max_nodes: 80
      max_edges: 160
      engine_bipartite: dot
      engine_flux: sfdp
      export_dot: true
      export_svg: true
      plots: [top_rop, top_wdot, patch, top_rop_reduced, flux_species]
    reduction_effect:
      top_n: 12
    params: {}

