name: reduce_gnn_importance_prune
steps:
  - id: sim
    task: sim.run
    sim: ${sim}
  - id: graph
    task: graphs.temporal_flux
    inputs:
      run_id: "@sim"
    params:
      windowing:
        type: log_time
        count: 3
        base: 10.0
      aggregation:
        mix:
          mean: 0.5
          p95: 0.5
      sparsify:
        quantile: 0.9
  - id: dataset
    task: gnn_dataset.temporal_graph_pyg
    inputs:
      run_id: "@sim"
      graph_id: "@graph"
    params:
      node_features: [X]
      split:
        train_ratio: 0.8
        val_ratio: 0.2
  - id: importance
    task: features.gnn_importance
    inputs:
      run_id: "@sim"
      graph_id: "@graph"
      dataset_id: "@dataset"
    params:
      rop_var: rop_net
      rop_use_abs: true
      gnn:
        alpha: 0.6
        steps: 1
        feature_norm: mean_abs
      output:
        reaction_feature: gnn_reaction_importance
        species_feature: gnn_species_importance
  - id: prune
    task: reduction.gnn_importance_prune
    inputs:
      mechanism: ${sim.mechanism}
      importance_id: "@importance"
      graph_id: "@graph"
    importance:
      reaction_feature: gnn_reaction_importance
      species_feature: gnn_species_importance
      aggregate: weighted
      qoi_weight: 2.0
      non_qoi_weight: 1.0
    thresholds:
      top_k: [8, 6, 4]
      score_lt: [1.0e-3, 5.0e-4]
      min_keep: 2
    params:
      qoi:
        selector: all
      validation:
        pipeline:
          steps:
            - id: sim
              task: sim.run
              sim: ${sim}
            - id: obs
              task: observables.run
              inputs:
                run_id: "@sim"
              params:
                observables:
                  - name: gas_composition
                    params:
                      stats: [last]
                      top_n: 2
                missing_strategy: skip
        metric: abs
        tolerance: 1.0e-6
        missing_strategy: skip
