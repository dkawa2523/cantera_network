# NetBench: reduction suite with multicase importance (ROP/GNN) + multi-case validation + viz
steps:
  # Single reference case for visualization (timeseries plots, network viz).
  - id: sim_ref
    task: sim.run_csv
    sim: ${sim}
    params:
      conditions_file: ${benchmarks.conditions_file}
      case_id: ${benchmarks.case_id}

  # Multi-case baseline used for temporal_flux + importance aggregation.
  - id: sim_train
    task: sim.sweep_csv
    sim: ${sim}
    params:
      conditions_file: ${benchmarks.conditions_file}
      case_mode: all
      # P0: temporal_flux requires identical time grid across runs.
      time_grid_policy: max

  - id: graph_mech
    task: graphs.stoich
    graphs:
      mechanism: ${mechanism.path}
    params: {}

  # Projection-only superstate mapping (analysis coordinate).
  - id: superstate_mapping
    task: reduction.superstate_mapping
    inputs:
      graph_id: "@graph_mech"
    params:
      guards:
        require_element_overlap: true
        require_heavy_element_overlap: true
        require_same_kind: true
        require_same_phase: true
        protected_species: [CO, CO2]
      mw_log_tol: 1.0
      elements_cosine_min: 0.2
      similarity:
        threshold: 0.93
        max_cluster_size: 20

  - id: graph_flux_ref
    task: graphs.temporal_flux
    inputs:
      run_id: "@sim_ref"
      mechanism: ${mechanism.path}
    params: {}

  - id: merge_quality
    task: features.superstate_merge_quality
    inputs:
      run_id: "@sim_ref"
      mapping_id: "@superstate_mapping"
    params:
      x_var: X

  # State merge candidate generation (mechanism-safe).
  - id: node_lumping
    task: reduction.node_lumping
    inputs:
      graph_id: "@graph_mech"
    lumping:
      method: threshold
      threshold: 0.95
      weights:
        elements: 0.7
        charge: 0.2
        phase: 0.1
        state: 0.0
      charge_scale: 2.0
      representative:
        metric: degree

  # Multi-case temporal flux graph (train runs).
  - id: graph_flux_train
    task: graphs.temporal_flux
    inputs:
      run_set_id: "@sim_train"
      mechanism: ${mechanism.path}
    params: {}

  # Multi-case ROP features (train runs).
  - id: features_rop_train
    task: features.run
    inputs: { run_set_id: "@sim_train" }
    params:
      cache_bust: "2026-02-11"
      features:
        - name: rop_wdot_summary
          params:
            rop:
              stats: [integral]
              top_n: 400
          rank_by: integral
          rank_abs: true

  # Single-case centrality features (graph-based; no run-set dependence).
  - id: features_centrality
    task: features.run
    inputs: { run_id: "@sim_ref", graph: "@graph_mech" }
    params:
      cache_bust: "2026-02-11"
      features:
        - name: network_metrics
          params:
            metrics: [betweenness]
            node_kinds: [reaction]
            top_n: 400
            betweenness_max_nodes: 1500

  # Multi-case GNN dataset + importance (train runs).
  - id: gnn_dataset_train
    task: gnn_dataset.temporal_graph_pyg
    inputs:
      run_set_id: "@sim_train"
      graph_id: "@graph_flux_train"
    params:
      node_features: [X]
      split:
        train_ratio: 0.8
        val_ratio: 0.2

  - id: features_gnn_train
    task: features.gnn_importance
    inputs:
      run_set_id: "@sim_train"
      graph_id: "@graph_flux_train"
      dataset_id: "@gnn_dataset_train"
    params:
      rop_var: rop_net
      rop_use_abs: true
      gnn:
        alpha: 0.6
        steps: 1
        feature_norm: mean_abs
      output:
        reaction_feature: gnn_reaction_importance
        species_feature: gnn_species_importance
        include_reactions: true
        include_species: false

  # ROP sweep (keep top_k reactions; disable the rest).
  - id: red_rop_k250
    task: reduction.threshold_prune
    inputs: { features: "@features_rop_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 250 }
  - id: red_rop_k200
    task: reduction.threshold_prune
    inputs: { features: "@features_rop_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 200 }
  - id: red_rop_k150
    task: reduction.threshold_prune
    inputs: { features: "@features_rop_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 150 }
  - id: red_rop_k120
    task: reduction.threshold_prune
    inputs: { features: "@features_rop_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 120 }
  - id: red_rop_k100
    task: reduction.threshold_prune
    inputs: { features: "@features_rop_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 100 }
  - id: red_rop_k80
    task: reduction.threshold_prune
    inputs: { features: "@features_rop_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 80 }
  - id: red_rop_k60
    task: reduction.threshold_prune
    inputs: { features: "@features_rop_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 60 }
  - id: red_rop_k50
    task: reduction.threshold_prune
    inputs: { features: "@features_rop_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 50 }

  # Centrality sweep.
  - id: red_cent_k250
    task: reduction.threshold_prune
    inputs: { features: "@features_centrality", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 250 }
  - id: red_cent_k200
    task: reduction.threshold_prune
    inputs: { features: "@features_centrality", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 200 }
  - id: red_cent_k150
    task: reduction.threshold_prune
    inputs: { features: "@features_centrality", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 150 }
  - id: red_cent_k120
    task: reduction.threshold_prune
    inputs: { features: "@features_centrality", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 120 }
  - id: red_cent_k100
    task: reduction.threshold_prune
    inputs: { features: "@features_centrality", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 100 }
  - id: red_cent_k80
    task: reduction.threshold_prune
    inputs: { features: "@features_centrality", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 80 }
  - id: red_cent_k60
    task: reduction.threshold_prune
    inputs: { features: "@features_centrality", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 60 }
  - id: red_cent_k50
    task: reduction.threshold_prune
    inputs: { features: "@features_centrality", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 50 }

  # GNN importance sweep.
  - id: red_gnn_k250
    task: reduction.threshold_prune
    inputs: { features: "@features_gnn_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 250 }
  - id: red_gnn_k200
    task: reduction.threshold_prune
    inputs: { features: "@features_gnn_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 200 }
  - id: red_gnn_k150
    task: reduction.threshold_prune
    inputs: { features: "@features_gnn_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 150 }
  - id: red_gnn_k120
    task: reduction.threshold_prune
    inputs: { features: "@features_gnn_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 120 }
  - id: red_gnn_k100
    task: reduction.threshold_prune
    inputs: { features: "@features_gnn_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 100 }
  - id: red_gnn_k80
    task: reduction.threshold_prune
    inputs: { features: "@features_gnn_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 80 }
  - id: red_gnn_k60
    task: reduction.threshold_prune
    inputs: { features: "@features_gnn_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 60 }
  - id: red_gnn_k50
    task: reduction.threshold_prune
    inputs: { features: "@features_gnn_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 50 }

  # LearnCK-style scaffolding (no-op patch) + external validation.
  - id: red_learnck
    task: reduction.dispatch
    method: learnck_style
    mechanism: ${mechanism.path}
    params:
      stable_states: reduction/learnck/stable_states.yaml

  # Reaction "merge" (cluster then keep representatives; disable the rest).
  - id: reaction_lumping
    task: reduction.reaction_lumping
    inputs:
      graph_id: "@graph_mech"
    lumping:
      method: threshold
      threshold: 0.8
      similarity:
        metric: jaccard
        mode: union
        weights:
          reactants: 0.5
          products: 0.5
        include_participants: false
      representative:
        metric: degree

  - id: red_rxn_merge
    task: reduction.reaction_lumping_prune
    inputs:
      reaction_lumping: "@reaction_lumping"
    mechanism: ${mechanism.path}
    params: {}

  # State merge gate sweep (mechanism-safe; merge only where constraints allow).
  - id: red_state_merge_gate_strict
    task: reduction.node_lumping_prune
    inputs: { node_lumping: "@node_lumping" }
    mechanism: ${mechanism.path}
    params:
      protected_species: [CO, CO2]
      require_same_composition: true
      require_same_charge: true
      thermo_constraints:
        enabled: true
        T_grid: [600, 1000, 1500, 2000]
        P_ref: 101325.0
        max_rel_cp: 0.25
        max_rel_h: 0.25
        max_rel_s: 0.25
        missing_strategy: skip
      kinetics_constraints:
        enabled: true
        T_grid: [600, 1000, 1500, 2000]
        P_ref: 101325.0
        X_ref: "N2:0.79, O2:0.21"
        eps: 1.0e-300
        species_signature: adjacent_logk_mean
        max_abs_log10k_diff: 1.0
        min_adj_size: 2
        missing_strategy: skip

  - id: red_state_merge_gate_mid
    task: reduction.node_lumping_prune
    inputs: { node_lumping: "@node_lumping" }
    mechanism: ${mechanism.path}
    params:
      protected_species: [CO, CO2]
      require_same_composition: true
      require_same_charge: true
      thermo_constraints:
        enabled: true
        T_grid: [600, 1000, 1500, 2000]
        P_ref: 101325.0
        max_rel_cp: 0.35
        max_rel_h: 0.35
        max_rel_s: 0.35
        missing_strategy: skip
      kinetics_constraints:
        enabled: true
        T_grid: [600, 1000, 1500, 2000]
        P_ref: 101325.0
        X_ref: "N2:0.79, O2:0.21"
        eps: 1.0e-300
        species_signature: adjacent_logk_mean
        max_abs_log10k_diff: 1.2
        min_adj_size: 2
        missing_strategy: skip

  - id: red_state_merge_gate_loose
    task: reduction.node_lumping_prune
    inputs: { node_lumping: "@node_lumping" }
    mechanism: ${mechanism.path}
    params:
      protected_species: [CO, CO2]
      require_same_composition: true
      require_same_charge: true
      thermo_constraints:
        enabled: true
        T_grid: [600, 1000, 1500, 2000]
        P_ref: 101325.0
        max_rel_cp: 0.50
        max_rel_h: 0.50
        max_rel_s: 0.50
        missing_strategy: skip
      kinetics_constraints:
        enabled: true
        T_grid: [600, 1000, 1500, 2000]
        P_ref: 101325.0
        X_ref: "N2:0.79, O2:0.21"
        eps: 1.0e-300
        species_signature: adjacent_logk_mean
        max_abs_log10k_diff: 2.0
        min_adj_size: 2
        missing_strategy: skip

  - id: red_state_merge_gate_off
    task: reduction.node_lumping_prune
    inputs: { node_lumping: "@node_lumping" }
    mechanism: ${mechanism.path}
    params:
      protected_species: [CO, CO2]
      require_same_composition: true
      require_same_charge: true
      thermo_constraints: { enabled: false }
      kinetics_constraints: { enabled: false }

  # Validate sweeps (multi-case QoI is the truth).
  - id: val_rop
    task: reduction.validate
    inputs:
      patches:
        - "@red_rop_k250"
        - "@red_rop_k200"
        - "@red_rop_k150"
        - "@red_rop_k120"
        - "@red_rop_k100"
        - "@red_rop_k80"
        - "@red_rop_k60"
        - "@red_rop_k50"
    mechanism: ${mechanism.path}
    validation:
      label: rop
      pipeline: ${oc.select:benchmarks.validation_pipeline,bench_gri30_netbench_validation}
      case_mode: all
      conditions_file: ${oc.select:benchmarks.validation_conditions_file,benchmarks/assets/conditions/gri30_netbench_val.csv}
      metric: rel
      tolerance: 0.5
      stop_on_fail: false
      use_multipliers_only: true
      sim_step_id: sim
      observables_step_id: observables
      features_step_id: features

  - id: val_centrality
    task: reduction.validate
    inputs:
      patches:
        - "@red_cent_k250"
        - "@red_cent_k200"
        - "@red_cent_k150"
        - "@red_cent_k120"
        - "@red_cent_k100"
        - "@red_cent_k80"
        - "@red_cent_k60"
        - "@red_cent_k50"
    mechanism: ${mechanism.path}
    validation:
      label: centrality
      pipeline: ${oc.select:benchmarks.validation_pipeline,bench_gri30_netbench_validation}
      case_mode: all
      conditions_file: ${oc.select:benchmarks.validation_conditions_file,benchmarks/assets/conditions/gri30_netbench_val.csv}
      metric: rel
      tolerance: 0.5
      stop_on_fail: false
      use_multipliers_only: true
      sim_step_id: sim
      observables_step_id: observables
      features_step_id: features

  - id: val_gnn
    task: reduction.validate
    inputs:
      patches:
        - "@red_gnn_k250"
        - "@red_gnn_k200"
        - "@red_gnn_k150"
        - "@red_gnn_k120"
        - "@red_gnn_k100"
        - "@red_gnn_k80"
        - "@red_gnn_k60"
        - "@red_gnn_k50"
    mechanism: ${mechanism.path}
    validation:
      label: gnn
      pipeline: ${oc.select:benchmarks.validation_pipeline,bench_gri30_netbench_validation}
      case_mode: all
      conditions_file: ${oc.select:benchmarks.validation_conditions_file,benchmarks/assets/conditions/gri30_netbench_val.csv}
      metric: rel
      tolerance: 0.5
      stop_on_fail: false
      use_multipliers_only: true
      sim_step_id: sim
      observables_step_id: observables
      features_step_id: features

  - id: val_state_merge_gates
    task: reduction.validate
    inputs:
      patches:
        - "@red_state_merge_gate_strict"
        - "@red_state_merge_gate_mid"
        - "@red_state_merge_gate_loose"
        - "@red_state_merge_gate_off"
      mapping_id: "@node_lumping"
    mechanism: ${mechanism.path}
    validation:
      label: node_lumping_prune_gates
      pipeline: ${oc.select:benchmarks.validation_pipeline_superstate,bench_gri30_netbench_validation_superstate}
      case_mode: all
      conditions_file: ${oc.select:benchmarks.validation_conditions_file,benchmarks/assets/conditions/gri30_netbench_val.csv}
      metric: rel
      tolerance: 0.5
      stop_on_fail: false
      use_multipliers_only: false
      sim_step_id: sim
      features_step_id: qoi
      inject_inputs:
        qoi:
          mapping_id: "$inputs.mapping_id"

  # Repair/selection: choose the best patch under multi-case validation.
  - id: repair_rop
    task: reduction.repair_topk
    inputs: { validation_id: "@val_rop" }
    params:
      policy:
        objective: disabled_reactions
        target_pass_rate: 1.0

  - id: repair_centrality
    task: reduction.repair_topk
    inputs: { validation_id: "@val_centrality" }
    params:
      policy:
        objective: disabled_reactions
        target_pass_rate: 1.0

  - id: repair_gnn
    task: reduction.repair_topk
    inputs: { validation_id: "@val_gnn" }
    params:
      policy:
        objective: disabled_reactions
        target_pass_rate: 1.0

  - id: repair_state_merge
    task: reduction.repair_topk
    inputs: { validation_id: "@val_state_merge_gates" }
    params:
      policy:
        objective: merged_species
        target_pass_rate: 0.95

  # Validate selected patches only (these are the ones shown in compare.md).
  - id: val_rop_selected
    task: reduction.validate
    inputs: { patches: ["@repair_rop"] }
    mechanism: ${mechanism.path}
    validation:
      label: rop_selected
      pipeline: ${oc.select:benchmarks.validation_pipeline,bench_gri30_netbench_validation}
      case_mode: all
      conditions_file: ${oc.select:benchmarks.validation_conditions_file,benchmarks/assets/conditions/gri30_netbench_val.csv}
      metric: rel
      tolerance: 0.5
      stop_on_fail: false
      use_multipliers_only: true
      sim_step_id: sim
      observables_step_id: observables
      features_step_id: features

  - id: val_centrality_selected
    task: reduction.validate
    inputs: { patches: ["@repair_centrality"] }
    mechanism: ${mechanism.path}
    validation:
      label: centrality_selected
      pipeline: ${oc.select:benchmarks.validation_pipeline,bench_gri30_netbench_validation}
      case_mode: all
      conditions_file: ${oc.select:benchmarks.validation_conditions_file,benchmarks/assets/conditions/gri30_netbench_val.csv}
      metric: rel
      tolerance: 0.5
      stop_on_fail: false
      use_multipliers_only: true
      sim_step_id: sim
      observables_step_id: observables
      features_step_id: features

  - id: val_gnn_selected
    task: reduction.validate
    inputs: { patches: ["@repair_gnn"] }
    mechanism: ${mechanism.path}
    validation:
      label: gnn_selected
      pipeline: ${oc.select:benchmarks.validation_pipeline,bench_gri30_netbench_validation}
      case_mode: all
      conditions_file: ${oc.select:benchmarks.validation_conditions_file,benchmarks/assets/conditions/gri30_netbench_val.csv}
      metric: rel
      tolerance: 0.5
      stop_on_fail: false
      use_multipliers_only: true
      sim_step_id: sim
      observables_step_id: observables
      features_step_id: features

  - id: val_state_merge_selected
    task: reduction.validate
    inputs:
      patches: ["@repair_state_merge"]
      mapping_id: "@node_lumping"
    mechanism: ${mechanism.path}
    validation:
      label: node_lumping_prune_selected
      pipeline: ${oc.select:benchmarks.validation_pipeline_superstate,bench_gri30_netbench_validation_superstate}
      case_mode: all
      conditions_file: ${oc.select:benchmarks.validation_conditions_file,benchmarks/assets/conditions/gri30_netbench_val.csv}
      metric: rel
      tolerance: 0.5
      stop_on_fail: false
      use_multipliers_only: false
      sim_step_id: sim
      features_step_id: qoi
      inject_inputs:
        qoi:
          mapping_id: "$inputs.mapping_id"

  - id: superreaction_merge
    task: graphs.superstate_reaction_merge_batch
    inputs:
      graph_id: "@graph_mech"
      mapping_id: "@superstate_mapping"
      patches:
        - "@repair_rop"
        - "@repair_centrality"
        - "@repair_gnn"
        - "@repair_state_merge"
        - "@red_learnck"
        - "@red_rxn_merge"
    params:
      drop_disabled: true
      allow_mixed_reaction_type: false
      use_reduced_mechanism: auto

  - id: cheap_metrics
    task: features.reduction_cheap_metrics
    inputs:
      graph_flux_id: "@graph_flux_train"
      patches:
        - "@repair_rop"
        - "@repair_centrality"
        - "@repair_gnn"
        - "@repair_state_merge"
        - "@red_learnck"
        - "@red_rxn_merge"
    params:
      top_k: 50

  - id: viz
    task: viz.benchmark_report
    name: bench_gri30_netbench_reduce_suite_supermerge_gnn_multicase_noamore
    dashboard: benchmark
    chart_backend: svg
    export_images:
      enabled: true
      formats: [svg]
      dir: images
    inputs:
      runs: "@sim_ref"
      graphs: ["@graph_mech", "@graph_flux_ref", "@superreaction_merge"]
      reduction:
        - "@superstate_mapping"
        - "@repair_rop"
        - "@repair_centrality"
        - "@repair_gnn"
        - "@repair_state_merge"
        - "@red_learnck"
        - "@red_rxn_merge"
      validation:
        - "@val_rop_selected"
        - "@val_centrality_selected"
        - "@val_gnn_selected"
        - "@val_state_merge_selected"
      features:
        - "@merge_quality"
        - "@cheap_metrics"
    graphviz:
      top_n: 8
      max_nodes: 80
      max_edges: 160
      engine_bipartite: dot
      engine_flux: sfdp
      export_dot: true
      export_svg: true
      plots: [top_rop, top_wdot, patch, top_rop_reduced, flux_species]
    reduction_effect:
      top_n: 12
    params: {}
