# Multicase restore experiment:
# 1) Start from an aggressive ROP-based prune (top_k=60),
# 2) validate across all cases,
# 3) restore a few high-importance reactions for failing cases,
# 4) validate again.
steps:
  - id: sim_train
    task: sim.sweep_csv
    sim: ${sim}
    params:
      conditions_file: ${benchmarks.conditions_file}
      case_mode: all
      time_grid_policy: max

  - id: graph_mech
    task: graphs.stoich
    graphs:
      mechanism: ${mechanism.path}
    params: {}

  - id: features_rop_train
    task: features.run
    inputs: { run_set_id: "@sim_train" }
    params:
      cache_bust: "2026-02-11"
      features:
        - name: rop_wdot_summary
          params:
            rop:
              stats: [integral]
              top_n: 600
          rank_by: integral
          rank_abs: true

  - id: red_rop_k60
    task: reduction.threshold_prune
    inputs: { features: "@features_rop_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 60 }

  - id: val_base
    task: reduction.validate
    inputs:
      patches: ["@red_rop_k60"]
    mechanism: ${mechanism.path}
    validation:
      label: rop_multicase_base_k60
      pipeline: ${oc.select:benchmarks.validation_pipeline,bench_gri30_netbench_validation}
      case_mode: all
      conditions_file: ${benchmarks.conditions_file}
      metric: rel
      tolerance: 0.5
      stop_on_fail: false
      use_multipliers_only: true
      sim_step_id: sim
      observables_step_id: observables
      features_step_id: features

  - id: repair_restore
    task: reduction.repair_restore
    inputs:
      base_reduction_id: "@red_rop_k60"
      validation_id: "@val_base"
      features_id: "@features_rop_train"
      run_set_id: "@sim_train"
    params:
      restore_per_case: 5
      max_total_restored: 40

  - id: val_repaired
    task: reduction.validate
    inputs:
      patches: ["@repair_restore"]
    mechanism: ${mechanism.path}
    validation:
      label: rop_multicase_repaired
      pipeline: ${oc.select:benchmarks.validation_pipeline,bench_gri30_netbench_validation}
      case_mode: all
      conditions_file: ${benchmarks.conditions_file}
      metric: rel
      tolerance: 0.5
      stop_on_fail: false
      use_multipliers_only: true
      sim_step_id: sim
      observables_step_id: observables
      features_step_id: features

