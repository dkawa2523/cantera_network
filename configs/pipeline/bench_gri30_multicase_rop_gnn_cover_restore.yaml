# Multicase reduction with targeted cover-restore:
# 1) Build multicase importance (ROP/GNN),
# 2) prune aggressively (top_k=60),
# 3) validate across all cases,
# 4) restore a small set of QoI-adjacent reactions using greedy case-cover,
# 5) validate repaired patch.
steps:
  - id: sim_train
    task: sim.sweep_csv
    sim: ${sim}
    params:
      conditions_file: ${benchmarks.conditions_file}
      case_mode: all
      time_grid_policy: max

  - id: graph_mech
    task: graphs.stoich
    graphs:
      mechanism: ${mechanism.path}
    params: {}

  - id: graph_flux_train
    task: graphs.temporal_flux
    inputs:
      run_set_id: "@sim_train"
      mechanism: ${mechanism.path}
    params: {}

  - id: features_rop_train
    task: features.run
    inputs: { run_set_id: "@sim_train" }
    params:
      cache_bust: "2026-02-11"
      features:
        - name: rop_wdot_summary
          params:
            rop:
              stats: [integral]
              top_n: 600
          rank_by: integral
          rank_abs: true

  - id: gnn_dataset_train
    task: gnn_dataset.temporal_graph_pyg
    inputs:
      run_set_id: "@sim_train"
      graph_id: "@graph_flux_train"
    params:
      node_features: [X]
      split:
        train_ratio: 0.8
        val_ratio: 0.2

  - id: features_gnn_train
    task: features.gnn_importance
    inputs:
      run_set_id: "@sim_train"
      graph_id: "@graph_flux_train"
      dataset_id: "@gnn_dataset_train"
    params:
      rop_var: rop_net
      rop_use_abs: true
      gnn:
        alpha: 0.6
        steps: 1
        feature_norm: mean_abs
      output:
        reaction_feature: gnn_reaction_importance
        species_feature: gnn_species_importance
        include_reactions: true
        include_species: false

  # ROP aggressive prune and targeted repair.
  - id: red_rop_k60
    task: reduction.threshold_prune
    inputs: { features: "@features_rop_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 60 }

  - id: val_rop_base
    task: reduction.validate
    inputs:
      patches: ["@red_rop_k60"]
    mechanism: ${mechanism.path}
    validation:
      label: rop_multicase_base_k60
      pipeline: ${oc.select:benchmarks.validation_pipeline,bench_gri30_netbench_validation}
      case_mode: all
      conditions_file: ${benchmarks.conditions_file}
      metric: rel
      tolerance: 0.5
      stop_on_fail: false
      use_multipliers_only: true
      sim_step_id: sim
      observables_step_id: observables
      features_step_id: features

  - id: repair_rop_cover
    task: reduction.repair_cover_restore
    inputs:
      base_reduction_id: "@red_rop_k60"
      validation_id: "@val_rop_base"
      features_id: "@features_rop_train"
      run_set_id: "@sim_train"
      graph_id: "@graph_mech"
    params:
      qoi_species: [CO2, CO]
      max_total_restored: 50
      max_candidates_per_case: 250
      fallback_restore_per_case: 2

  - id: val_rop_repaired
    task: reduction.validate
    inputs:
      patches: ["@repair_rop_cover"]
    mechanism: ${mechanism.path}
    validation:
      label: rop_multicase_cover_repaired
      pipeline: ${oc.select:benchmarks.validation_pipeline,bench_gri30_netbench_validation}
      case_mode: all
      conditions_file: ${benchmarks.conditions_file}
      metric: rel
      tolerance: 0.5
      stop_on_fail: false
      use_multipliers_only: true
      sim_step_id: sim
      observables_step_id: observables
      features_step_id: features

  # GNN aggressive prune and targeted repair.
  - id: red_gnn_k60
    task: reduction.threshold_prune
    inputs: { features: "@features_gnn_train", graph_id: "@graph_mech" }
    importance: { column: value, mode: abs, aggregate: max }
    threshold: { top_k: 60 }

  - id: val_gnn_base
    task: reduction.validate
    inputs:
      patches: ["@red_gnn_k60"]
    mechanism: ${mechanism.path}
    validation:
      label: gnn_multicase_base_k60
      pipeline: ${oc.select:benchmarks.validation_pipeline,bench_gri30_netbench_validation}
      case_mode: all
      conditions_file: ${benchmarks.conditions_file}
      metric: rel
      tolerance: 0.5
      stop_on_fail: false
      use_multipliers_only: true
      sim_step_id: sim
      observables_step_id: observables
      features_step_id: features

  - id: repair_gnn_cover
    task: reduction.repair_cover_restore
    inputs:
      base_reduction_id: "@red_gnn_k60"
      validation_id: "@val_gnn_base"
      features_id: "@features_gnn_train"
      run_set_id: "@sim_train"
      graph_id: "@graph_mech"
    params:
      qoi_species: [CO2, CO]
      max_total_restored: 50
      max_candidates_per_case: 250
      fallback_restore_per_case: 2

  - id: val_gnn_repaired
    task: reduction.validate
    inputs:
      patches: ["@repair_gnn_cover"]
    mechanism: ${mechanism.path}
    validation:
      label: gnn_multicase_cover_repaired
      pipeline: ${oc.select:benchmarks.validation_pipeline,bench_gri30_netbench_validation}
      case_mode: all
      conditions_file: ${benchmarks.conditions_file}
      metric: rel
      tolerance: 0.5
      stop_on_fail: false
      use_multipliers_only: true
      sim_step_id: sim
      observables_step_id: observables
      features_step_id: features

